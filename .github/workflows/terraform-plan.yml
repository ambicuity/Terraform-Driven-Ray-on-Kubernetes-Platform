name: Terraform Plan

on:
  pull_request:
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-plan.yml'
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: us-east-1
  TF_VAR_environment: dev
  TF_VAR_repo_name: ${{ github.repository }}
  TF_VAR_commit_sha: ${{ github.sha }}

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
      
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-TerraformPlan
      
      - name: Terraform Format Check
        id: fmt
        working-directory: ./terraform
        run: terraform fmt -check -recursive
        continue-on-error: true
      
      - name: Terraform Init
        id: init
        working-directory: ./terraform
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"
      
      - name: Terraform Validate
        id: validate
        working-directory: ./terraform
        run: terraform validate -no-color
      
      - name: Setup OPA
        uses: open-policy-agent/setup-opa@v2
        with:
          version: latest
      
      - name: Run OPA Policy Tests
        id: opa
        working-directory: ./policies
        run: |
          echo "Testing Terraform policies..."
          opa test . -v
        continue-on-error: true
      
      - name: Terraform Plan
        id: plan
        working-directory: ./terraform
        run: |
          terraform plan \
            -no-color \
            -out=tfplan \
            -var="github_token=${{ steps.generate-token.outputs.token }}"
        continue-on-error: true
      
      - name: Generate Plan Summary
        id: plan-summary
        if: always()
        run: |
          cd terraform
          # Extract resource changes
          terraform show -no-color tfplan > plan.txt || true
          
          # Count changes
          ADD=$(grep -c "will be created" plan.txt || echo "0")
          CHANGE=$(grep -c "will be updated" plan.txt || echo "0")
          DESTROY=$(grep -c "will be destroyed" plan.txt || echo "0")
          
          echo "add=$ADD" >> $GITHUB_OUTPUT
          echo "change=$CHANGE" >> $GITHUB_OUTPUT
          echo "destroy=$DESTROY" >> $GITHUB_OUTPUT
      
      - name: Run OPA Policy Check on Plan
        id: opa-check
        working-directory: ./terraform
        run: |
          terraform show -json tfplan > plan.json
          opa eval --data ../policies/terraform.rego --input plan.json "data.terraform.deny" | tee opa-result.txt
          
          # Check if any denials
          if grep -q "true" opa-result.txt; then
            echo "‚ùå Policy violations detected"
            exit 1
          fi
        continue-on-error: true
      
      - name: Post Plan to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          PLAN_OUTPUT: ${{ steps.plan.outputs.stdout }}
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const output = `#### Terraform Plan Results üìä
            
            | Check | Status |
            |-------|--------|
            | Format | \`${{ steps.fmt.outcome }}\` |
            | Initialize | \`${{ steps.init.outcome }}\` |
            | Validate | \`${{ steps.validate.outcome }}\` |
            | Policy Check | \`${{ steps.opa-check.outcome }}\` |
            | Plan | \`${{ steps.plan.outcome }}\` |
            
            #### Resource Changes
            - **Create**: ${{ steps.plan-summary.outputs.add }} resources
            - **Update**: ${{ steps.plan-summary.outputs.change }} resources
            - **Delete**: ${{ steps.plan-summary.outputs.destroy }} resources
            
            <details><summary>Show Plan Output</summary>
            
            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`
            
            </details>
            
            *Triggered by: @${{ github.actor }} | Commit: ${{ github.sha }}*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
      
      - name: Create Check Run
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const conclusion = '${{ steps.plan.outcome }}' === 'success' && 
                             '${{ steps.opa-check.outcome }}' === 'success' 
                             ? 'success' : 'failure';
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Terraform Plan',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: 'Terraform Plan Results',
                summary: `Resources to create: ${{ steps.plan-summary.outputs.add }}, update: ${{ steps.plan-summary.outputs.change }}, delete: ${{ steps.plan-summary.outputs.destroy }}`,
              }
            });
      
      - name: Upload Plan Artifact
        if: steps.plan.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: terraform/tfplan
          retention-days: 5
      
      - name: Exit on Plan Failure
        if: steps.plan.outcome == 'failure' || steps.opa-check.outcome == 'failure'
        run: |
          echo "‚ùå Terraform plan or policy check failed"
          exit 1
