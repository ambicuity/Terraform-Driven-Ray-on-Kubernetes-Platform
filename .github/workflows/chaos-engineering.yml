name: Chaos Engineering / Resilience Validation

on:
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Environment to run chaos against'
        required: true
        default: 'staging'
  schedule:
    # Run at 3 AM UTC every Sunday to test weekly infrastructure integrity
    - cron: '0 3 * * 0'

permissions:
  id-token: write
  contents: read

jobs:
  chaos-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install kubernetes ray

      # Configure AWS credentials via OIDC when CHAOS_RUNNER_ROLE_ARN secret is set.
      # In order to run against a live EKS cluster, set the CHAOS_RUNNER_ROLE_ARN
      # repository secret to the IAM role ARN that has EKS describe/access permissions.
      - name: Configure AWS Credentials
        if: ${{ secrets.CHAOS_RUNNER_ROLE_ARN != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.CHAOS_RUNNER_ROLE_ARN }}
          aws-region: us-west-2

      - name: Generate Kubeconfig (EKS)
        if: ${{ secrets.CHAOS_RUNNER_ROLE_ARN != '' }}
        run: |
          aws eks update-kubeconfig --region us-west-2 --name ray-production-cluster

      - name: Set up Python 3.11
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install "ray[default]>=2.9.0" "kubernetes>=28.1.0"

      - name: Execute Chaos Engineering Workload
        run: python workloads/chaos_test.py
        env:
          # When no EKS cluster is configured, Ray initialises locally and the
          # Kubernetes pod-deletion path is skipped gracefully by chaos_test.py.
          RAY_ADDRESS: "auto"
