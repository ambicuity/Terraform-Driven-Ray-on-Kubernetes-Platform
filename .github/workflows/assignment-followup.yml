name: Assignment Follow-up

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM UTC
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  followup:
    name: Check Stale Assignments
    runs-on: ubuntu-latest
    steps:
      - name: Ping stale assignees
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const now = new Date();
            const NUDGE_DAYS = 3;
            const ESCALATE_DAYS = 7;

            // Fetch all open issues with assignees
            const { data: issues } = await github.rest.issues.listForRepo({
              owner, repo,
              state: 'open',
              per_page: 100,
              assignee: '*'
            });

            for (const issue of issues) {
              // Skip PRs (GitHub API returns PRs as issues)
              if (issue.pull_request) continue;
              // Skip issues with skip-ai label
              if (issue.labels.some(l => l.name === 'skip-ai')) continue;

              const assignees = issue.assignees.map(a => a.login);
              if (assignees.length === 0) continue;

              // Find when the issue was last assigned (check timeline)
              let assignedAt = null;
              let lastBotPing = null;

              try {
                const { data: timeline } = await github.rest.issues.listEventsForTimeline({
                  owner, repo,
                  issue_number: issue.number,
                  per_page: 100
                });

                // Find the most recent assignment event
                for (const event of timeline.reverse()) {
                  if (event.event === 'assigned' && !assignedAt) {
                    assignedAt = new Date(event.created_at);
                  }
                }

                // Check for recent bot pings to avoid spamming
                const { data: comments } = await github.rest.issues.listComments({
                  owner, repo,
                  issue_number: issue.number,
                  per_page: 20
                });

                for (const c of comments.reverse()) {
                  if (c.body && c.body.includes('ðŸ“‹ Assignment Check-in') && c.user.login === 'github-actions[bot]') {
                    lastBotPing = new Date(c.created_at);
                    break;
                  }
                }
              } catch (e) {
                console.log(`Error processing issue #${issue.number}: ${e.message}`);
                continue;
              }

              if (!assignedAt) continue;

              const daysSinceAssigned = Math.floor((now - assignedAt) / (1000 * 60 * 60 * 24));
              const daysSincePing = lastBotPing ? Math.floor((now - lastBotPing) / (1000 * 60 * 60 * 24)) : Infinity;

              // Skip if we already pinged in the last 3 days
              if (daysSincePing < 3) continue;

              const mentions = assignees.map(a => `@${a}`).join(' ');

              // --- ESCALATION: 7+ days, no PR ---
              if (daysSinceAssigned >= ESCALATE_DAYS) {
                await github.rest.issues.createComment({
                  owner, repo,
                  issue_number: issue.number,
                  body: `## ðŸ“‹ Assignment Check-in\n\n` +
                        `${mentions} â€” this issue has been assigned for **${daysSinceAssigned} days** ` +
                        `with no linked Pull Request.\n\n` +
                        `**Please reply with a status update:**\n\n` +
                        `| Command | Action |\n|---|---|\n` +
                        `| \`/working\` | Confirm you're actively working on this |\n` +
                        `| \`/eta 2 days\` | Set an expected completion time |\n` +
                        `| \`/not-working\` | Unassign yourself so others can pick it up |\n` +
                        `| \`/blocked\` | Flag this as blocked |\n\n` +
                        `> âš ï¸ If there is no response within 3 days, this issue may be unassigned ` +
                        `to keep the backlog moving.\n\n` +
                        `---\n*Automated follow-up by Assignment Tracker.*`
                });

                // Add needs-triage if not already present
                try {
                  await github.rest.issues.addLabels({
                    owner, repo,
                    issue_number: issue.number,
                    labels: ['needs-triage']
                  });
                } catch (e) { /* label may not exist */ }
              }
              // --- NUDGE: 3+ days ---
              else if (daysSinceAssigned >= NUDGE_DAYS) {
                await github.rest.issues.createComment({
                  owner, repo,
                  issue_number: issue.number,
                  body: `## ðŸ“‹ Assignment Check-in\n\n` +
                        `Hey ${mentions} ðŸ‘‹ â€” just checking in! ` +
                        `This issue has been assigned for **${daysSinceAssigned} days**.\n\n` +
                        `How's progress? Reply with:\n` +
                        `- \`/working\` â€” I'm on it\n` +
                        `- \`/eta <timeframe>\` â€” e.g., \`/eta 2 days\`\n` +
                        `- \`/not-working\` â€” Unassign me\n` +
                        `- \`/blocked\` â€” I'm stuck on something\n\n` +
                        `---\n*Automated follow-up by Assignment Tracker.*`
                });
              }

              console.log(`Issue #${issue.number}: assigned ${daysSinceAssigned} days ago to ${assignees.join(', ')}`);
            }
