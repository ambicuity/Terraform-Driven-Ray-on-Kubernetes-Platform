# Repository Cognitive Memory Layer

This directory is a **git-native, version-controlled cognitive substrate** for the AI agents
in this repository. All files here are deterministically generated by GitHub Actions and
validated by a CI gate before being committed.

## Overview

The memory system provides agents with six types of persistent memory:

| Memory Type | File | Description |
|---|---|---|
| Structural | `repo_graph.json` | File nodes, import edges, call relationships |
| Module | `module_map.json` | Module boundaries and component ownership |
| Dependency | `dependency_graph.json` | Cross-file and cross-module dependency depth |
| Infrastructure | `infra_graph.json` | Terraform resources, Helm charts, OPA policies |
| CI | `ci_graph.json` | Workflow triggers, steps, failure history |
| Decision | `decision_log.json` | ARCH_DECISION tags, ADRs, PR-extracted rationale |
| Semantic | `embeddings/` | Vector embeddings for code, docs, issues, PRs |

## Schema Version

All JSON files include a `schema_version` field. The current schema version is **1.0**.
The `validate_memory.py` CI gate enforces schema correctness before any commit.

## Embedding Model

- **Model**: `BAAI/bge-small-en-v1.5` (384-dim, ~130 MB)
- **Version tag**: stored in `embeddings/file_embeddings.json` → `model_name` field
- **Cache key**: hashed model name — CI never re-downloads if cache hits
- If the model is upgraded, all embedding files **must** be regenerated (validator enforces this)

## Incremental Update Strategy

Each embedding record carries a `hash` (SHA-256 of file content). On PR merge:

1. `git diff HEAD~1 --name-only` detects changed files
2. Only changed files are re-embedded (typically < 30 seconds)
3. Embeddings for deleted files are pruned
4. `decision_log.json` is appended if the PR body contains `ARCH_DECISION:` markers

## Size Constraints

The validator enforces a **50 MB hard cap** across all memory files. Individual caps:

| File | Limit |
|---|---|
| `embeddings/file_embeddings.json` | 15 MB |
| `embeddings/doc_embeddings.json` | 5 MB |
| `embeddings/issue_embeddings.json` | 5 MB |
| `embeddings/pr_embeddings.json` | 5 MB |
| All structural graphs combined | 5 MB |
| `decision_log.json` | 2 MB |

## Retrieval at Agent Runtime

Agents use `scripts/memory_retriever.py` and `scripts/agent_context_builder.py` — both
are **stdlib-only** (no sentence-transformers required at runtime). The retrieval is pure
cosine similarity over the pre-computed flat JSON embedding arrays.

**Upgrade path**: When total chunk count exceeds ~5,000, replace the cosine scan in
`memory_retriever.py` with FAISS (`faiss-cpu` wheel) and store the index as `embeddings/faiss.index`.
The retriever API (`top_k`) is designed to remain unchanged across this migration.

## Agent Decision Tags

Embed architectural annotations in source code comments using these tags:

```python
# ARCH_DECISION: Using label-swap as distributed lock — prevents concurrent Delta runs
# SECURITY_BOUNDARY: Agents cannot write to .github/workflows/ — enforced in gh_utils.py
# PERFORMANCE_CONSTRAINT: Gemini Pro thinking budget capped at 8192 tokens for code gen
```

`decision_extractor.py` scans all `.py`, `.tf`, `.rego`, and `.md` files and appends
structured records to `decision_log.json`.

## CI Workflow

| Workflow | Trigger | Purpose |
|---|---|---|
| `memory.yml` | push to main, weekly | Full memory rebuild + validation |
| `memory-incremental.yml` | push to main (post-merge) | Hash-incremental embedding update |

Memory commits use `[skip ci]` in the commit message to prevent recursive trigger loops.
